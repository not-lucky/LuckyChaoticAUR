name: Build AUR Packages

on:
  workflow_dispatch:
    inputs:
      package:
        description: 'Specific package to build (leave empty for all)'
        required: false
        default: ''
      force:
        description: 'Force rebuild even if up-to-date'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'

env:
  REPO_NAME: luckychaoticaur

jobs:
  # Job 1: Parse packages.yaml and prepare build matrix
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      repo_name: ${{ steps.set-matrix.outputs.repo_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download versions.json from release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Try to download versions.json from existing release
          if gh release download repo --pattern "versions.json" --dir . 2>/dev/null; then
            echo "Downloaded existing versions.json"
            cat versions.json
          else
            echo "No versions.json found, creating empty one"
            echo "{}" > versions.json
          fi

      - name: Upload versions.json as artifact
        uses: actions/upload-artifact@v4
        with:
          name: versions-cache
          path: versions.json
          retention-days: 1

      - name: Parse packages.yaml
        id: set-matrix
        run: |
          # Install yq for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          # Get repository name
          REPO_NAME=$(yq '.repository.name' packages.yaml)
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT

          # Build package matrix
          if [[ -n "${{ github.event.inputs.package }}" ]]; then
            # Single package specified
            PACKAGES='["${{ github.event.inputs.package }}"]'
          else
            # All packages from yaml
            PACKAGES=$(yq -o=json '.packages[].name' packages.yaml | jq -s -c '.')
          fi

          echo "matrix={\"package\":$PACKAGES}" >> $GITHUB_OUTPUT
          echo "Packages to build: $PACKAGES"

  # Job 2: Build packages in parallel using matrix strategy
  build:
    needs: prepare
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Arch Linux build environment
        run: |
          # Update system and install build dependencies
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git jq curl sudo

          # Create build user (makepkg doesn't run as root)
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

          # Setup directories
          mkdir -p /build/aur /build/repo/x86_64
          chown -R builder:builder /build
          chown -R builder:builder .

      - name: Download versions cache
        uses: actions/download-artifact@v4
        with:
          name: versions-cache
          path: /build

      - name: Import GPG key
        if: env.GPG_PRIVATE_KEY != ''
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "$GPG_PRIVATE_KEY" | base64 -d | sudo -u builder gpg --import
          echo "GPGKEY=$(sudo -u builder gpg --list-secret-keys --keyid-format LONG | grep sec | awk '{print $2}' | cut -d'/' -f2)" >> $GITHUB_ENV

      - name: Get package configuration
        id: pkg-config
        run: |
          # Install yq
          curl -sL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

          PKG="${{ matrix.package }}"

          # Check if skip_pgp_check is set
          SKIP_PGP=$(yq ".packages[] | select(.name == \"$PKG\") | .skip_pgp_check // false" packages.yaml)
          echo "skip_pgp=$SKIP_PGP" >> $GITHUB_OUTPUT

          # Check if force_rebuild is set
          FORCE=$(yq ".packages[] | select(.name == \"$PKG\") | .force_rebuild // false" packages.yaml)
          echo "force_rebuild=$FORCE" >> $GITHUB_OUTPUT

      - name: Fetch PKGBUILD from AUR
        id: fetch
        env:
          FORCE_BUILD: ${{ github.event.inputs.force == 'true' || steps.pkg-config.outputs.force_rebuild == 'true' }}
        run: |
          chmod +x scripts/fetch-pkgbuild.sh
          
          # Build fetch arguments
          FETCH_ARGS="${{ matrix.package }} /build/aur --versions-file /build/versions.json"
          if [[ "$FORCE_BUILD" == "true" ]]; then
            FETCH_ARGS="$FETCH_ARGS --force"
          fi
          
          sudo -u builder ./scripts/fetch-pkgbuild.sh $FETCH_ARGS || exit_code=$?
          if [[ "${exit_code:-0}" -eq 4 ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Package available in official repos - skipping"
            exit 0
          elif [[ "${exit_code:-0}" -eq 5 ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Package version unchanged - skipping"
            exit 0
          elif [[ "${exit_code:-0}" -ne 0 ]]; then
            exit $exit_code
          fi
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Build package
        if: steps.fetch.outputs.skip != 'true'
        env:
          SKIP_PGP_CHECK: ${{ steps.pkg-config.outputs.skip_pgp == 'true' && '1' || '' }}
          PACKAGER: ${{ secrets.PACKAGER || 'LuckyChaoticAUR <noreply@github.com>' }}
        run: |
          chmod +x scripts/build-package.sh
          cd /build
          sudo -u builder SKIP_PGP_CHECK="$SKIP_PGP_CHECK" PACKAGER="$PACKAGER" GPGKEY="${GPGKEY:-}" \
            $GITHUB_WORKSPACE/scripts/build-package.sh "${{ matrix.package }}" /build/aur /build/repo/x86_64

      - name: Get built package version
        if: steps.fetch.outputs.skip != 'true'
        id: built-version
        run: |
          # Extract version from aur-info.json
          VERSION=$(jq -r '.Version' /build/aur/${{ matrix.package }}/aur-info.json 2>/dev/null || echo "")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Built version: $VERSION"

      - name: Upload built packages
        if: steps.fetch.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.package }}
          path: /build/repo/x86_64/*.pkg.tar.zst*
          retention-days: 7

      - name: Upload version info
        if: steps.fetch.outputs.skip != 'true' && steps.built-version.outputs.version != ''
        uses: actions/upload-artifact@v4
        with:
          name: version-${{ matrix.package }}
          path: /build/aur/${{ matrix.package }}/aur-info.json
          retention-days: 1

  # Job 3: Generate repository database and deploy to GitHub Releases
  deploy:
    needs: [prepare, build]
    # Run even if some build jobs failed (e.g., package name typo in packages.yaml)
    # Only skip if the workflow was cancelled
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git github-cli jq

      - name: Download all package artifacts
        uses: actions/download-artifact@v4
        with:
          path: repo/x86_64
          pattern: package-*
          merge-multiple: true

      - name: Download versions cache
        uses: actions/download-artifact@v4
        with:
          name: versions-cache
          path: .

      - name: Download version info artifacts
        uses: actions/download-artifact@v4
        with:
          path: version-info
          pattern: version-*
          merge-multiple: true
        continue-on-error: true

      - name: Update versions.json with built packages
        run: |
          echo "Current versions.json:"
          cat versions.json
          
          # Update versions.json with newly built package versions
          if [[ -d version-info ]]; then
            for info_file in version-info/aur-info.json version-info/*/aur-info.json; do
              [[ -f "$info_file" ]] || continue
              PKG_NAME=$(jq -r '.Name' "$info_file")
              PKG_VERSION=$(jq -r '.Version' "$info_file")
              if [[ -n "$PKG_NAME" && -n "$PKG_VERSION" && "$PKG_NAME" != "null" && "$PKG_VERSION" != "null" ]]; then
                echo "Updating $PKG_NAME to version $PKG_VERSION"
                jq --arg pkg "$PKG_NAME" --arg ver "$PKG_VERSION" '.[$pkg] = $ver' versions.json > versions.tmp && mv versions.tmp versions.json
              fi
            done
          fi
          
          echo "Updated versions.json:"
          cat versions.json

      - name: Import GPG key for database signing
        if: env.GPG_PRIVATE_KEY != ''
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_PRIVATE_KEY" | base64 -d | gpg --import
          echo "GPGKEY=$(gpg --list-secret-keys --keyid-format LONG | grep sec | awk '{print $2}' | cut -d'/' -f2)" >> $GITHUB_ENV

      - name: Generate repository database
        env:
          REPO_NAME: ${{ needs.prepare.outputs.repo_name }}
        run: |
          chmod +x scripts/update-repo.sh
          ./scripts/update-repo.sh "$REPO_NAME" repo/x86_64

      - name: List repository contents
        run: |
          echo "=== x86_64 packages ==="
          ls -lah repo/x86_64/

      - name: Configure git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Create or update release
        env:
          REPO_NAME: ${{ needs.prepare.outputs.repo_name }}
        run: |
          cd repo/x86_64

          # Check if release exists
          if gh release view repo --repo "$GITHUB_REPOSITORY" > /dev/null 2>&1; then
            echo "Release 'repo' exists, updating..."
          else
            echo "Creating release 'repo'..."
            gh release create repo \
              --repo "$GITHUB_REPOSITORY" \
              --title "$REPO_NAME Repository" \
              --notes "Arch Linux package repository. Add to pacman.conf:

          [$REPO_NAME]
          SigLevel = Optional TrustAll
          Server = https://github.com/$GITHUB_REPOSITORY/releases/download/repo" \
              --latest
          fi

          # Upload all files (--clobber overwrites existing)
          echo "Uploading packages and database files..."
          gh release upload repo \
            --repo "$GITHUB_REPOSITORY" \
            --clobber \
            *.pkg.tar.zst *.db* *.files* 2>/dev/null || true

          # Upload signature files if they exist
          if ls *.sig 1> /dev/null 2>&1; then
            gh release upload repo \
              --repo "$GITHUB_REPOSITORY" \
              --clobber \
              *.sig
          fi

          # Upload updated versions.json
          echo "Uploading versions.json..."
          cp "$GITHUB_WORKSPACE/versions.json" ./versions.json
          gh release upload repo \
            --repo "$GITHUB_REPOSITORY" \
            --clobber \
            versions.json

          echo "=== Release upload complete ==="
